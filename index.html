<!DOCTYPE html>
<html lang="ja">
  <html manifest="/cache.manifest">
    <head>
      <title id="title">横浜市の人口ピラミッド（市、区別、町丁別）</title>
      <meta charset="utf-8" />
      <meta
        name="description"
        content="横浜市がWebサイトで公表している人口統計を利用して作成できる全ての人口ピラミッドを自由自在に表示できる。あらゆる年、区、複数の町丁目を含む小地域の人口ピラミッド。将来推計人口による将来予測も。横浜市の公表するオープンデータをリアルタイムで取得するので、公表されたばかりの人口統計をタイムラグなしにすぐに人口ピラミッドで見ることができる。"
      />
      <meta
        name="key words"
        content="オープンデータ,人口ピラミッド,将来推計人口,横浜市,町・丁目,小地域"
      />
      <meta name="author" content="INUZUKA Katsu" />
      <meta name="viewport" content="width=device-width, initial-scale=1" />
      <link
        rel="stylesheet"
        href="./js/jquery-ui-1.12.1/jquery-ui.min.css"
        type="text/css"
      />
      <!-- Tippy.js CSS -->
      <link
        rel="stylesheet"
        href="https://unpkg.com/tippy.js@6/dist/tippy.css"
      />
      <script type="text/javascript" src="./js/pyramid.js"></script>
      <script type="text/javascript" src="./js/PyramidSVGRenderer.js"></script>
      <script type="text/javascript" src="./js/streaming-animation.js"></script>
      <script type="text/javascript" src="./js/ui-synchronizer.js"></script>
      <script
        type="text/javascript"
        src="./js/interpolation-animation.js"
      ></script>
      <script type="text/javascript" src="./js/jquery-3.1.1.js"></script>
      <script
        type="text/javascript"
        src="./js/jquery-ui-1.12.1/jquery-ui.min.js"
      ></script>
      <!-- Tippy.js JavaScript -->
      <script src="https://unpkg.com/@popperjs/core@2"></script>
      <script src="https://unpkg.com/tippy.js@6"></script>
      <script type="text/javascript" src="/js/html2canvas.js"></script>
      <script type="text/javascript">
        // Tippy.js ツールチップ設定
        var w;
        $(function () {
          w = $(window).width();
          initializeTooltips();
        });
        $(window).resize(function () {
          w = $(window).width();
          // Tippy.jsは自動的にリサイズに対応
        });

        function initializeTooltips() {
          // ツールチップコンテンツの定義（複数行で自然に記述）
          // placement:
          //   top, top-start, top-end
          //   bottom, bottom-start, bottom-end
          //   left, left-start, left-end
          //   right, right-start, right-end
          //   自動調整: auto, auto-start, auto-end
          const tooltipContents = {
            new_info_tooltip: {
              content: `
                <p class="bura_sage">1. SVG (Scalable Vector Graphics)というグラフィックフォーマットできれいな人口ピラミッドを描画できるようになりました。縮小・拡大も自由自在です。</p>
                <p class="bura_sage">2. 区の将来推計人口の新しいデータが公表されていたので、2017年の将来推計人口から差し替えました。区についても2070年までの人口ピラミッドを見ることができます。</p>
                <p class="bura_sage">3. 長期時系列統計の区５歳階級別人口のピラミッドを表示できるようになりました。区についても昭和時代の人口ピラミッドを見ることができます。</p>
                <p class="bura_sage">4. アニメーション（動画）の機能を大幅に拡充しました。棒が伸び縮みするアニメーションや人口増減をピラミッドの大きさの変化でみることのできるアニメーションを選ぶことができます。スピード調整や、アニメーションの途中で気になるところがあったとき、スライドバーで任意の時点に戻ったり進めたりすることもできます。ぜひ動画ボタンをクリックしてお試しください。</p>
                <p class="bura_sage">5. スライドバーで簡単に年次を切り替えることができるようになりました。</p>
              `,
              placement: "bottom-start",
              maxWidth: 450,
              interactive: false,
            },
            about_site_tooltip: {
              content: `
                <p class="indent">横浜市がWebサイトで公表している年齢別人口統計を利用して人口ピラミッドを表示するサイトです。</p>
                <p class="indent">統計がある全ての年の横浜市、行政区、任意の町丁目を含む地域の人口ピラミッドを表示することができます。(年２回公表される住民基本台帳による統計は９月30日現在の統計を採用)</p>
                <p class="indent">2024年に公表された2070年までの将来推計人口による将来予測も人口ピラミッドで表示。</p>
                <p class="indent">横浜市がHPで公表しているオープンデータをリアルタイムで取得するので、新しい統計が公表されたときタイムラグなしにすぐに人口ピラミッドで見ることができます。</p>
              `,
              placement: "bottom-start",
              maxWidth: 450,
              interactive: false,
            },
            info_pyramid_size_tooltip: {
              content: `
                <p class="bura_sage">1. 人口ピラミッドの大きさについて<br>
                  　人口ピラミッドは、年齢構成を視覚的に把握するためのグラフです。<br>
                  　総人口が違っても年齢構成が同じであれば全く同じグラフにならなければなりません。<br>
                  　そのため、このサイトでは、総人口の多寡によらずグラフの面積が常に一定となるように計算して描画しています。</p>
                <p class="bura_sage">2. しかし、例外として、人口ピラミッドの変化をアニメーション（動画）で見るときには、
                    人口の増減を人口ピラミッドの大きさ(面積)の変化で見ることのできるオプションを用意しました。<br>
                  　大正、昭和の時代を通じて横浜市の人口が劇的に増大した様子をピラミッドの形の変化と合わせて見ることができます。<br>
                  　将来推計による人口減少の様子もある程度見て取ることができます。是非一度お試しください。</p>
              `,
              placement: "bottom-start",
              maxWidth: 450,
              interactive: false,
            },
            about_data_source_tooltip: {
              content: `
                <p class="bura_sage">1. このサイトの人口ピラミッドは、すべて横浜市のWebサイトから取得した年齢別人口統計を利用して作成しています。</p>
                <p class="bura_sage">2. しかし残念ながら、横浜市Webサイトのリニューアルの結果、
                      行政区別の各歳別人口統計は2003年(平成15年)以降のものしか2025年9月現在の横浜市のWebサイトには掲載されていません。
                      (本サイトではかつて取得した1993年(平成5年)からのデータを利用。また、住民基本台帳による人口は1995年(平成7年)以降のものが横浜市Webサイトに掲載されている。)</p>
                <p class="bura_sage">3. 人口ピラミッドの下に表示されるURLは、データ取得時のものであり、現在ではリンク切れになってしまったものがありますことをご了承ください。</p>
              `,
            },
            about_browser_tooltip: {
              content: `
                <p class="indent">PC、Mac、iPhone、iPadで動作を確認しています。</p>
                <p class="indent">ブラウザは、Chrome、Firefox、Safari、Microsoft Edgeで動作確認しています。</p>
                <p class="indent">今のところ、MacのSafariでスクリーンショットの画像が崩れてしまう不具合を確認しています。</p>
                <p class="indent">Macをお使いの方は、ChromeなどSafari以外のブラウザをご利用ください。</p>
              `,
              placement: "bottom-end",
              maxWidth: 450,
              interactive: false,
            },
            info_3kubun_tooltip: {
              content: `
                <p class="bura_sage">1. セレクトボックスで年齢3区分別の人口と構成比を切替えることができます。非表示にもできます。</p>
                <p class="bura_sage">2. 中段の年齢区分「15〜64歳」の「15」と「64」の部分を別の年齢に変更することができます。<br>
                　例えば、中位の年齢区分を「65〜75歳」とすれば、前期高齢者、後期高齢者の人数や構成比を見ることができます。</p>
                <p class="bura_sage">3. ピラミッドと重なって見にくいときは</p>
                <p class="bura_sage4">　方策1 年齢３区分別構成比と表示されているセレクトボックスで非表示を選択する。（総人口・男・女の表示は残ります。) </p>
                <p class="bura_sage4">　方策2 <button>年齢３区分別等表示ON/OFF</button>ボタンで「総人口・男・女」を含めて非表示にする。</p>
                <p class="bura_sage4">　方策3 ズームの<button>− 縮小</button>ボタンで、重ならないようにピラミッドを縮小する。</p>
                <p class="bura_sage2">　※ <button>年齢３区分別等表示ON/OFF</button>と<button>− 縮小</button>は、画面左側 (スマホ・タブレットではピラミッドの下方) にあります。</p>
              `,
              placement: "top-start",
              maxWidth: 450,
              interactive: false,
            },
            info_animation_tooltip: {
              content: `
                <p class="bura_sage">1. アニメーションの種類について</p>
                <p class="bura_sage2">(1) <span class="border"><input type="radio" checked /> 通常タイプ　<input type="radio" /> 伸び縮みタイプ</span></p>
                <p class="bura_sage2">　<input type="radio" checked /> 通常タイプ は、紙芝居のように人口ピラミッドを年を追って切り替えて表示します。</p>
                <p class="bura_sage2">　<input type="radio" checked /> 伸び縮みタイプ は、各歳の棒の長さが伸び縮みして年々の変化をおもしろく表示します。</p>
                <p class="bura_sage2">(2) <span class="border"><input type="radio" checked /> 年齢構成　<input type="radio" /> 年齢構成 + 人口増減</span></p>
                <p class="bura_sage2">　<input type="radio" checked /> 年齢構成 を選択すると、一定の大きさの人口ピラミッドが年齢構成の変化によって形を変えていく様子を見ることができます。<br>
                   人口ピラミッドは形の違いで年齢構成の違いを見るためのグラフなので、人口ピラミッドの本来の見方に沿った表現ということができます。</p>
                <p class="bura_sage2">　<input type="radio" checked /> 年齢構成 + 人口増減 を選択すると、人口の増減を反映して人口ピラミッドの大きさが変化します。<br>
                   人口ピラミッドの面積が厳密に人口に比例するように描画しています。<br>
                   市域拡大に加えて市外からの流入で人口が急激に増加した大正、昭和時代の横浜市の様子などを興味深く見ることができます。</p>
                <p class="bura_sage">2. <button>開始</button>ボタンをクリックすると、アニメーションが開始されます。</p>
                <p class="bura_sage">3. 進行状況スライダーバーについて</p>
                <p class="bura_sage2">　<button>一時停止</button>してからスライダーバーを動かすことで、見返したい年次に戻ることができます。</p>
                <p class="bura_sage2">　<button>再開</button>ボタンでその年次からのアニメーションを再開します。</p>
              `,
              placement: "bottom-start",
              maxWidth: 450,
              interactive: false,
            },
            cho_link_tooltip: {
              content: `
                <p class="bura_sage">1. 町丁選択パネルの表示<br>
                    　左のリンクをクリックすると人口ピラミッドの下にある町丁選択パネルをスクロール表示します。</p>
                <p class="bura_sage">2. 地域の人口ピラミッドの表示方法<br>
                <p class="bura_sage2">(1) 町丁選択パネルで、人口ピラミッドを見たいと思う地域に含まれる町丁のチェックボックスをチェックしてください。</p>
                <p class="bura_sage2">(2) 町丁のチェックを終えたら、[町丁別人口ピラミッド]ボタンをクリックしてください。</p>
                <p class="bura_sage2">(3) 指定した町丁を合わせた地域の人口ピラミッドが表示されます。</p>
                <p class="bura_sage2">(4) 人口ピラミッドの上の年月セレクトボックスで別の年次を選択すると、同じ地域の別に年の人口ピラミッドを見ることができます。</p>
                <p class="bura_sage">3. 区や市のピラミッドへの戻り方<br>
                  　町丁選択パネル上部にある<button>市区全体の人口ピラミッド</button>ボタンをクリックすると表示中の地域を含む区全体の人口ピラミッドを表示します。<br>
                  　人口ピラミッド上部の市区選択セレクトボックスで横浜市や他の区を選択しても、市または区の人口ピラミッドに戻ることができます。</p>
               `,
              placement: "bottom-start",
              maxWidth: 450,
              interactive: false,
            },
            doga_button_tooltip: {
              content: `
                <p class="bura_sage">1. <button>動画</button>ボタンについて<br>
                  　表示中の市区・地域の人口ピラミッドの変化(=年齢構成の移り変わり)をアニメーションのように見ることができます。<br>
                  　クリックするとアニメーションのための操作ボタンなどが表示されます。</p>
                <p class="bura_sage">2. スライダーバーについて<br>　スライドバーを左右に動かすことによって素早くセレクトボックスの年次を変えることができます。</p>
              `,
              placement: "bottom-end",
              maxWidth: 450,
              interactive: false,
            },
            screen_shot_tooltip: {
              content: `
                <p class="bura_sage"><strong>1. スクリーンショットの使い道</strong></p>
                <p class="bura_sage2">(1) 人口ピラミッドの画像ファイルをダウンロードして、人口ピラミッドをWordやPowerPointなどに貼り付けて利用することができます。</p>
                <p class="bura_sage2">(2) 比較したい人口ピラミッドを並べて表示し、見比べることができます。</p>
                <p class="bura_sage"><strong>2. 具体的な操作の方法</strong></p>
                <p class="bura_sage2">(1) 作成<br>
                    <button>スクリーンショット</button>ボタンをクリックすると、このページの下部にイメージが埋め込まれます。</p>
                <p class="bura_sage2">(2) ダウンロード<br>
                    画像データをダウンロードしたいときは、イメージの右のチェックボックスをチェックしてから<button>ダウンロード</button>ボタンをクリックしてください。<br>
                    <strong>iPhone、iPad</strong>では、画像を長押しするとメニューが表示されるので、"写真に保存"、"共有"などを選択してください。</p>
                <p class="bura_sage2">(3) 複数の人口ピラミッドの比較<br>
                    市区や地域を変えたり時点を変えて様々の人口ピラミッドを表示させ、それらのスクリーンショットを撮ってください。<br>
                    ページの下の方に撮影したイメージが並んで表示されます。並べることのできる数に制限はありません。</p>
              `,
              placement: "top-start",
              maxWidth: 450,
              interactive: false,
            },
            info_cho_pyramid_tooltip: {
              content: `
                <p class="bura_sage">1. 地域の人口ピラミッドを描く方法<br>
                  町丁名をチェックしてから<button>町丁別人口ピラミッド</button>ボタンをクリックしてください。<br>
                  隣接する複数の町丁を選択してその地域の人口ピラミッドを描くことができます。</p>
                <p class="bura_sage">2. 区全体の人口ピラミッドに戻るときは<button>区全体の人口ピラミッド</button>ボタンをクリックしてください。</p>
              `,
              placement: "top-end",
              maxWidth: 450,
              interactive: false,
            },
          };
          // ヘッダーツールチップ（クリック表示）
          $(".header").each(function () {
            const tooltipText = $(this).attr("data-tooltip");
            if (tooltipText) {
              tippy(this, {
                content: tooltipText,
                placement: "top",
                theme: "light",
                trigger: "click",
                interactive: false,
                maxWidth: 400,
                allowHTML: true,
                arrow: true,
                offset: [0, 10],
                onShow(instance) {
                  // HTMLタグが正しく表示されるように再設定
                  instance.setContent(tooltipText);
                },
              });
            }
          });

          // その他のツールチップ（クリック表示）
          $(
            ".info-icon-left, .info-icon-right, .info-icon-bottom, .info-icon-3kubun, [data-tooltip-id]"
          ).each(function () {
            // data-tooltip-id属性がある場合は、定義されたコンテンツを使用
            const tooltipId = $(this).attr("data-tooltip-id");
            let tooltipConfig;

            if (tooltipId && tooltipContents[tooltipId]) {
              const config = tooltipContents[tooltipId];
              // 新しいオブジェクト構造か従来の文字列かを判定
              if (typeof config === "object" && config.content) {
                tooltipConfig = config;
              } else {
                // 従来の文字列形式
                tooltipConfig = { content: config };
              }
            } else {
              // 従来のdata-tooltip属性を使用
              const tooltipText = $(this).attr("data-tooltip");
              tooltipConfig = { content: tooltipText };
            }

            if (tooltipConfig && tooltipConfig.content) {
              // 表示方向の決定（優先順位: オブジェクト設定 > data-placement > クラス名 > デフォルト）
              let placement = tooltipConfig.placement || "bottom"; // デフォルト

              // data-placement属性をチェック（オブジェクト設定がない場合のみ）
              if (!tooltipConfig.placement) {
                const dataPlacement = $(this).attr("data-placement");
                if (dataPlacement) {
                  placement = dataPlacement;
                } else {
                  // クラス名で判定（data-tooltip-id属性がある場合はクラス名による方向指定をスキップ）
                  if ($(this).attr("data-tooltip-id")) {
                    placement = "top"; // デフォルト（tooltipContentsのplacementが優先される）
                  } else if ($(this).hasClass("tooltip-top")) {
                    placement = "top";
                  } else if ($(this).hasClass("tooltip-bottom")) {
                    placement = "bottom";
                  } else if ($(this).hasClass("tooltip-left")) {
                    placement = "left";
                  } else if ($(this).hasClass("tooltip-right")) {
                    placement = "right";
                  } else if ($(this).hasClass("info-icon-bottom")) {
                    placement = "top";
                  } else if ($(this).hasClass("info-icon-right")) {
                    placement = "left";
                  }
                }
              }

              // Tippy.jsの設定を構築
              const tippyOptions = {
                content: tooltipConfig.content,
                placement: placement,
                theme: "light",
                trigger: "click",
                interactive: tooltipConfig.interactive || false,
                maxWidth: tooltipConfig.maxWidth || 400,
                allowHTML: true,
                arrow: true,
                offset: [0, 10],
                onShow(instance) {
                  // HTMLタグが正しく表示されるように再設定
                  instance.setContent(tooltipConfig.content);
                },
              };

              tippy(this, tippyOptions);
            }
          });
        }

        function device(pc, mobile) {
          if (w > 1800) {
            return direction(pc);
          } else {
            return direction(mobile);
          }
        }
        function direction(nsew) {
          if (nsew == "top") {
            return "south";
          } else if (nsew == "bottom") {
            return "north";
          } else if (nsew == "left") {
            return "east";
          } else {
            return "west";
          }
        }
      </script>
      <!--link type="text/css" href="./css/pyramid.css" rel="stylesheet"-->
      <style type="text/css">
        * {
          box-sizing: border-box; /* ボックスサイズにパディングやボーダーを含める */
        }
        p.indent {
          text-indent: 1em;
        }
        p.bura_sage {
          text-indent: -1em;
          padding-left: 1em;
        }
        p.bura_sage2 {
          text-indent: -2em;
          padding-left: 2em;
        }
        p.bura_sage3 {
          text-indent: -3em;
          padding-left: 3em;
        }
        p.bura_sage4 {
          text-indent: -4em;
          padding-left: 4em;
        }
        /* ツールチップの説明中の文字をボタンのように表示する */
        p button {
          font-size: 10pt;
          padding: 4px 6px;
          margin: 0 2px;
          border: 1px solid #5a6b7c;
          /*border-radius: 6px;*/
          /*background: linear-gradient(145deg, #6b7b8c 0%, #5a6b7c 50%, #4a5b6c 100%);*/
          background: hsl(36, 50%, 57%);
          color: #1e1e1f;
          cursor: pointer;
          transition: all 0.2s ease;
          font-weight: 550;
          /*text-shadow: 1px 1px 2px rgba(0,0,0,0.5);*/
          box-shadow: inset 0 1px 2px rgba(255, 255, 255, 0.1),
            0 2px 4px rgba(0, 0, 0, 0.3);
        }
        /* ツールチップの説明中の文字を枠囲みにする */
        .border {
          border: 1px solid #494f53;
          padding: 0.2em 0.7em;
          border-radius: 1px;
        }
        /* Tippy.js カスタムスタイル */
        .tippy-box[data-theme~="light"] {
          background-color: #fff;
          color: #333;
          border: 1px solid #e0e0e0;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
          font-size: 14px;
          line-height: 1.4;
          max-width: 400px;
        }

        .tippy-box[data-theme~="light"] .tippy-content {
          padding: 12px 16px;
        }

        .tippy-box[data-theme~="light"] .tippy-arrow {
          color: #fff;
        }

        .tippy-box[data-theme~="light"] .tippy-arrow::before {
          border: 1px solid #e0e0e0;
        }

        /* スクリーンショットツールチップ専用スタイル */
        #screen_shot_tooltip {
          transition: color 0.2s ease;
        }

        #screen_shot_tooltip:hover {
          color: #007bff !important;
        }

        #main {
          padding: 20px;
        }
        #title-container {
          text-align: center;
          margin-left: 260px;
        }
        /* 描画領域上部に並ぶコントロール */
        #top-controls {
          display: grid;
          grid-template-columns: 1fr;
          grid-template-rows: auto;
          justify-content: center;
          align-items: start;
          gap: 10px;
          height: auto;
          min-height: 100px;
        }
        #link {
          grid-column: 1/2;
          grid-row: 1/2;
          align-self: center ;
          justify-self: end;
        }
        #select-controls {
          grid-column: 1/2;
          grid-row: 2/3;
          align-self: center ;
          justify-self: end;
          height: auto;
        }
        #animation-controls {
          visibility: hidden;
          grid-column: 1/2;
          grid-row: 1/3;
          justify-self: center;
          align-self: start;
          text-align: center;
          margin: 0 auto;
          background-color: transparent;
          border-radius: 0;
          box-shadow: none;
        }
        #animation-type-section {
          display: flex;
          flex-direction: row;
          align-items: center;
          justify-content: flex-start;
          gap: 1.5em;
          margin-bottom: 10px;
          padding: 5px 5px 5px 0;
        }
        #animation-radio-buttons {
          display: flex;
          flex-direction: row;
          gap: 1em;
        }
        #animation-execute-section {
          align-items: center;
        }
        #animation-settings-block {
          display: flex;
          flex-direction: column;
          gap: 8px;
          min-width: 300px;
          align-items: flex-start;
        }
        #animation-btn-block {
          display: flex;
          flex-direction: row;
          align-items: center;
          justify-content: center;
          height: 100%;
          gap: 5px;
        }
        #animation-btn-group1,
        #animation-btn-group2 {
          display: flex;
          flex-direction: row;
          gap: 5px;
        }
        /* #pyramid-blockと#left-controlsのコンテナ */
        /* 子要素をflexで横並びにする */
        #container-flex {
          display: flex;
          flex-direction: row-reverse;
          align-items: flex-start;
          justify-content: center;
          gap: 20px;
          padding: 10px;
          font-size:100%; /* レスポンシブで変更 */
        }
        /*#container-flexの子要素1*/
        #pyramid-block {
          display: flex;
          flex-direction: column;
          max-width: 1148px;
          margin-bottom: 20px;
        }
        /*#container-flexの子要素2*/
        /* 左端に縦に並ぶコントロール用のスタイル */
        .left-controls {
          width: 250px;
          min-width: 200px;
          margin-top: 70px;
          gap: 10px;
        }
        /* #pyramid-blockの子要素1 */
        #top-controls {
          order: 1;
        }
        /* #pyramid-blockの子要素2 */
        #pyramid-container {
          order: 2;
        }
        /* #pyramid-blockの子要素3 */
        #source_container {
          order: 3;
        }
        /* #pyramid-blockの子要素4 */
        #cho {
          order: 4;
        }
        /* SVGと#basic_dataのコンテナ */
        #pyramid-container {
          display: grid;
          grid-template-columns: 1fr;
          grid-template-rows: auto;
          min-width: 0;         /* SVG内容に引っ張られないようにする */
          max-width: 1148px;    /* 上限を固定 */
          width: 1148px;          /* 親の幅にフィット */
          height: auto;
        }
        #basic_data {
            grid-column: 1/2;
            grid-row: 1/2;
            z-index: 1000;
            align-self: flex-end;
            justify-self: flex-end;
            font-size: 11pt;
            text-align: right;
            display: block;
          }
          #source_container {
            max-width: 1000px;
          }
        /*border: 1px solid #ddd;
          border-radius: 5px;
          background: white;
          min-height: 600px;
          margin-left: 20px;
          margin-right: auto;
          margin-bottom: 20px;
          overflow: auto;*/

        .left-controls .control-group {
          background: #e6e6d1;
          padding: 15px;
          border-radius: 12px;
          border: 1px solid #d4d4b8;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
          transition: all 0.2s ease;
        }

        /*.left-controls .control-group:hover {
          box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
          transform: translateY(-2px);
        }*/

        .left-controls .control-group h3 {
          margin: 0 0 10px 0;
          color: #495057;
          font-size: 1em;
          border-bottom: 2px solid #007bff;
          padding-bottom: 5px;
        }

        .left-controls .button-group {
          display: flex;
          flex-direction: column;
          gap: 8px;
        }

        .left-controls .radio-group {
          display: flex;
          flex-direction: row;
          gap: 8px;
          margin-top: 10px;
          justify-content: center;
        }

        .left-controls .radio-group label {
          font-size: 12px;
        }

        .control-group {
          display: flex;
          flex-direction: column;
          gap: 5px;
        }

        .control-group label {
          font-weight: bold;
          color: #555;
        }

        .control-group select,
        .control-group input {
          padding: 10px 14px;
          border: 1px solid #dee2e6;
          border-radius: 8px;
          background: #ffffff;
          font-size: 14px;
          transition: all 0.2s ease;
          /*box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);*/
        }

        .control-group select:focus,
        .control-group input:focus {
          outline: none;
          border-color: #4a90e2;
          box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
        }

        #cho {
          z-index: 1;
        }
        #cho-buttons {
          display: flex;
          flex-direction: row;
          gap: 5px;
        }

        #source_container {
          margin-bottom: 10px;
        }

        #footer {
          margin-top: 30px;
          /*margin-left: 260px;*/
          z-index: 1000;
        }

        /* デモデータコントロールを不可視に */
        .demo-controls {
          display: none !important;
        }

        @media screen, print {
          body {
            font-family: "Hiragino Kaku Gothic ProN", "Meiryo", "Helvetica Neue",
              "Helvetica", "Hiragino Sans", "Arial", "Yu Gothic", sans-serif;
          }

          a.header {
            margin: 0 0 0 0.5em;
            text-decoration: none;
            color: #3399ff;
          }
          img {
            vertical-align: -17%;
            width: 1em;
            height: 1.2em;
            margin-right: 0.5em;
          }
          img.small-icon {
            vertical-align: -17%;
            width: 1.5em;
            height: 1.5em;
          }
          caption {
            text-align: right;
          }
          select,
          input {
            font-size: 11pt;
            padding: 6px 10px;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            background: #ffffff;
            transition: all 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
          }

          select:focus,
          input:focus {
            outline: none;
            border-color: #4a90e2;
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
          }

          select:hover,
          input:hover {
            border-color: #adb5bd;
          }
          button,
          input[type="button"] {
            font-size: 11pt;
            padding: 8px 16px;
            border: 1px solid #5a6b7c;
            /*border-radius: 6px;*/
            /*background: linear-gradient(145deg, #6b7b8c 0%, #5a6b7c 50%, #4a5b6c 100%);*/
            background: hsl(36, 50%, 57%);
            color: #1e1e1f;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            /*text-shadow: 1px 1px 2px rgba(0,0,0,0.5);*/
            box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.1),
              0 4px 8px rgba(0, 0, 0, 0.3);
          }

          button:hover,
          input[type="button"]:hover {
            /*background: linear-gradient(145deg, #5a6268 0%, #3d4043 50%, #2c2e30 100%);*/
            box-shadow: inset 0 2px 4px rgba(255, 255, 255, 0.15),
              inset 0 -2px 4px rgba(0, 0, 0, 0.4), 0 6px 12px rgba(0, 0, 0, 0.4);
          }

          button:active,
          input[type="button"]:active {
            transform: translateY(0);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.3),
              inset 0 -2px 4px rgba(255, 255, 255, 0.1),
              0 2px 4px rgba(0, 0, 0, 0.3);
          }
          h1 {
            font-size: 200%;
            font-weight: bold;
            margin-top: 5px;
            text-align: center;
            background: #f6f6ec;
            color: #2c2e30;
            padding: 15px 30px;
            border: 1px solid #d4d4b8;
            border-radius: 4px;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.3);
            display: inline-block;
            margin: 20px auto;
            position: relative;
            /*margin-left: 260px;*/
            width: 15em;
            box-sizing: border-box;
          }

          h2 {
            margin-top: 5px;
            font-weight: normal;
            background: #f6f6ec;
            color: #2c2e30;
            padding: 5px 20px;
            border: 1px solid #d4d4b8;
            border-radius: 4px;
            box-shadow: 0px 1px 1px rgba(0, 0, 0, 0.3);
            position: relative;
            box-sizing: border-box;
            width: auto;
            max-width: 1108px;
            min-width: 300px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            height: 60px;
            overflow: hidden;
          }
          }
          h2 span.small {
            font-size: 85%;
            font-weight: 400;
          }
          h2 span#h2-text {
            display: inline-block;
            font-size: 22px;
            width: 100%;
            height: 100%;
          }
          div#header {
            text-align: right;
            font-size: 80%;
            color: #0099ff;
            width: 100%;
            margin-right: 1em;
          }
          div#main {
            text-align: center;
            /*width:1108px;*/
            margin-left: auto;
            margin-right: auto;
          }
          div#select-controls {
            width: 100%;
            text-align: right;
            margin-left: auto;
            margin-right: 0px;
            display: inline-block;
            vertical-align: top;
            position: relative;
          }
          div#link {
            margin-left: auto;
            width: 100%;
            white-space: nowrap;
            display: block;
            text-align: right;
            gap: 8px;
            white-space: nowrap;
            margin-bottom: 0.5m;
          }
          div#animation-type-controls {
            text-align: center;
          }
          div#comment {
            position: absolute;
            left: 0;
            top: -20px;
            color: red;
            border: 1px solid red;
            padding: 5px;
          }
          div#hitoku {
            position: absolute;
            left: 10px;
            top: 10px;
            color: #0099ff;
            font-size: 80%;
            width: 30%;
            text-align: left;
            display: block;
          }
          div#cho {
            display: inline-block;
            vertical-align: top;
            margin-top: 1em;
            padding: 20px;
            background: #f5f5dc;
            border: 2px solid #d4d4b8;

            box-shadow: 
              /*inset 2px 2px 4px rgba(0,0,0,0.4),*/ inset
              4px 4px 8px 0px rgba(60, 56, 56, 0.29);
            position: relative;
          }

          div#cho_list {
            display: block;
            margin: 0.5em 0 0.5em 0;
            text-align: center;
            font-size: 11pt;
            color: #495057;
          }
          div.cho {
            display: inline-block;
            margin-left: 0;
            margin-top: 0.5em;
            vertical-align: top;
            text-align: left;
          }
          div.footer {
            text-align: center;
            width: 100%;
            margin-left: auto;
            margin-right: auto;
            font-size: 11pt;
          }
          /*div#option        { position: absolute;
                              top:5px;
                              left:5px;
                              font-size:11pt;
                              max-width:20em;
                            }*/
          div#storage_alert {
            padding: 5px 5px 5px 5px;
            color: red;
            display: none;
          }
          fieldset {
            margin: 0;
            padding: 0 5px 5px 5px;
          }
          li {
            list-style-type: none;
            padding-left: 0;
            text-indent: -0.2em;
          }
          span.inline-block {
            display: inline-block;
          }
          #jinko_sosu {
            display: table;
            margin-left: auto;
            margin-right: 0;
            margin-bottom: 1em;
          }
          #jinko_sosu span.tr {
            display: table-row;
          }
          #jinko_sosu span.td {
            display: table-cell;
            line-height: 12pt;
            padding: 2px 2px 2px 2px;
          }
          div#select {
            text-align: right;
            margin-bottom: 5px;
          }
          #kubun_unit {
            width: 12em;
          }
          #nenrei_3kubun {
            display: table;
            position: relative;
            bottom: 0px;
            right: 0px;
            margin-left: auto;
          }
          #nenrei_3kubun span.tr {
            display: table-row;
          }
          #nenrei_3kubun span.td {
            display: table-cell;
            line-height: 12pt;
            padding: 0px 5px 0px 5px;
            text-align: right;
          }
          #nenrei_3kubun input {
            width: 2.5em;
            height: 0.5em;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 2px;
            font-size: 10pt;
            background-color: #f9f9f9;
            transition: all 0.3s ease;
            position: relative;
            z-index: 1;
          }
          #nenrei_3kubun input:focus {
            border-color: #0066cc;
            background-color: #fff;
            outline: none;
            box-shadow: 0 0 3px rgba(0, 102, 204, 0.3);
            z-index: 10;
            transform: scale(1.1);
          }
          #nenrei_3kubun input:hover {
            border-color: #999;
            z-index: 10;
            transform: scale(1.1);
          }

          /* セル全体を一つのブロックとして扱う */
          #nenrei_3kubun .age-cell-container {
            position: relative;
            display: inline-block;
            white-space: nowrap;
          }

          #nenrei_3kubun .age-text {
            display: inline-block;
            margin: 0 1px;
          }

          /* スピンコントロールの隠し表示 - セル内絶対配置 */
          #nenrei_3kubun .age-input-container {
            position: absolute;
            display: inline-block;
            width: 2.5em;
            height: 1.2em;
            top: -3px;
            z-index: 1;
          }

          /* 開始年齢の位置 */
          #nenrei_3kubun .age-input-container:first-of-type {
            left: -0.6em;
          }

          /* 終了年齢の位置（〜の後） */
          #nenrei_3kubun .age-input-container:last-of-type {
            left: 2em; /* 空白 + 〜 の幅分 - 半文字分左に移動 */
          }

          #nenrei_3kubun .age-display {
            display: inline-block;
            width: 100%;
            height: 100%;
            text-align: center;
            padding: 2px;
            font-weight: 600;
            color: #1616179a;
            cursor: pointer;
            border: 1px solid transparent;
            border-radius: 3px;
            transition: all 0.3s ease;
            line-height: 1.2em;
          }

          #nenrei_3kubun .age-display:hover {
            background-color: #f0f0f0;
            border-color: #ccc;
          }

          #nenrei_3kubun .age-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            pointer-events: none;
            z-index: 5;
            transform: scale(0.8);
            transition: all 0.3s ease;
          }

          #nenrei_3kubun .age-input-container:hover .age-input {
            opacity: 1;
            pointer-events: auto;
            transform: scale(1.1);
            z-index: 10;
          }

          #nenrei_3kubun .age-input-container:hover .age-display {
            opacity: 0;
            pointer-events: none;
          }
          #nenrei_3kubun span.right {
            text-align: right;
          }
          #sosu,
          #male,
          #female {
            text-align: right;
          }
          #red {
            font-weight: normal;
            font-size: 90%;
            color: red;
          }
          #screen_shot_button {
            margin-top: 0.5em;
          }
          #screen_shot_section {
            text-align: center;
          }
          img.img_screenshot {
            vertical-align: middle;
            width: 400px;
            height: auto;
            border: 2px #336699 solid;
          }
          input.chk_screenshot {
            margin-left: 0;
            margin-right: 1em;
          }

          /*jQueryのダイアログボックスのデザイン*/
          .ui-dialog {
            line-height: 1.5em;
          }
          .ui-dialog-titlebar {
            margin-bottom: 0.5em;
          }
          .ui-widget {
            font-size: 1.2em;
          }
          .ui-dialog-buttonset {
            line-height: 1em;
          }
          .ui-dialog .ui-dialog-buttonpane {
            padding: 0;
          }
          span#dialog {
            display: block;
            padding: 0.5em;
            text-indent: 1em;
          }
          .ui-widget-header {
            background: #2b80d5;
            color: white;
          }
          .ui-widget.ui-widget-content {
            border-color: #2b80d5;
          }
        }

        @media print {
          div.left {
            border: 1px solid blue;
            background-color: blue;
          }
          div.right {
            border: 1px solid red;
            background-color: red;
          }
          div#link,
          div#option {
            display: none !important;
          }
          h2 {
            font-size: 250%;
            text-align: center;
          }
          div#male_label,
          div#female_label {
            color: black;
            border: 1px solid black;
          }
        }

        /* 額縁効果のスタイル */
        #pyramid-container {
          background: linear-gradient(
            145deg,
            #e6c350 0%,
            #b9a58d 50%,
            #e6b841 100%
          );
          padding: 20px;
          border-radius: 15px;
          box-shadow: inset 0 0 20px rgba(0, 0, 0, 0.3),
            0 8px 25px rgba(0, 0, 0, 0.4), 0 0 0 3px #8b7355, 0 0 0 6px #d4af37;
          margin: 20px auto;
          /*position: relative;*/
        }

        #pyramid-container::before {
          content: "";
          position: absolute;
          top: 10px;
          left: 10px;
          right: 10px;
          bottom: 10px;
          border: 2px solid #f4e4bc;
          border-radius: 8px;
          pointer-events: none;
        }

        /* スクリーンショット撮影時に::before疑似要素のボーダーを非表示にする */
        #pyramid-container.screenshot-mode::before {
          border: none;
        }
        #loading-container {
          margin-left: 260px;
        }
        /* ローディングスピナーアニメーション */
        @keyframes spin {
          0% {
            transform: rotate(0deg);
          }
          100% {
            transform: rotate(360deg);
          }
        }
        /* 幅が狭い場合（例: 1380px以下）にfixed解除して縦並びに */
        @media (max-width: 1380px) {
          #loading-container {
            margin-left: 0;
          }
          #title-container {
            text-align: center;
            margin-left: 0;
          }
          /* 親コンテナを縦並びへ */
          #container-flex {
            flex-direction: column;
            align-items: center;
            justify-content: center;
          }
          #pyramid-block {
            width: 100% !important;
            left: auto !important;
            top: auto !important;
            margin: 0;
            margin-left: 0;
            margin-right: 0;
          }
          #pyramid-container {
            max-width: 1148px;
            width: 100%;
          }
          .left-controls {
            position: static !important;
            transform: none;
            width: 100%;
            max-width: 100%;
            margin-top: 1em;
            box-shadow: none;
          }
          /* コントロール各グループを横並びに */
          .left-controls {
            display: flex;
            flex-direction: row; /* 横並び */
            gap: 30px;
            align-items: flex-start; /* 上揃え */
            justify-content: center;
            flex-wrap: wrap; /* 画面狭いとき折り返し可能 */
          }
          .left-controls .control-group {
            width: 220px; /* 必要に応じて調整 */
            /*height: 150px; /* 高さも指定可能 */
            box-sizing: border-box; /* paddingやborderが含まれる計算に */
          }
          /* ラベルを左寄せ・固定幅など調整 */
          .left-controls .control-group label {
            min-width: 80px;
            white-space: nowrap;
          }

          /* 入力やボタンは適宜伸縮 */
          .left-controls .control-group select,
          .left-controls .control-group input,
          .left-controls .control-group button {
            flex: 1 1 auto;
          }
          div#cho {
            display: none;
            width: 100% !important;
            max-width: 100%;
            margin: 1em auto;
            box-sizing: border-box;
          }
        }
        div.footer {
          margin-top: 0px;
        }

        /* ローディング表示のレスポンシブ対応 */
        @media screen and(max-width: 1200px) {
          #main {
            padding: 10px;
          }
          #container-flex {
            padding: 0;
          }
        }

        @media screen and (max-width: 850px) {
          /*div#animation-controls {
            padding-left: 50px;
          }*/
        }

        /* スマホ用：額縁を最小限にしてSVGを大きく表示 */
        @media screen and (max-width: 768px) {
          #main {
            padding: 5px;
          }
          h1 {
            font-size: 140%;
            margin-top: 0px;
            margin-bottom: 5px;
            box-shadow: none;
          }
          h2 {
            font-size: 120%;
            margin-top: 0px;
            margin-bottom: 10px;
            box-shadow: none;
          }
          #container-flex {
            font-size:85%;
          }
          div#animation-controls {
            padding-left: 0px;
          }
          #container-flex {
            padding: 0;
          }
          #pyramid-container {
            padding: 5px; /* 20px → 5px に縮小 */
            margin: 10px auto; /* 20px → 10px に縮小 */
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.2),
              /* 影も軽く */ 0 4px 15px rgba(0, 0, 0, 0.3), 0 0 0 2px #8b7355,
              /* 3px → 2px */ 0 0 0 4px #d4af37; /* 6px → 4px */
          }
          #basic_data {
            display: none;
          }
          #pyramid-container::before {
            top: 5px; /* 10px → 5px */
            left: 5px; /* 10px → 5px */
            right: 5px; /* 10px → 5px */
            bottom: 5px; /* 10px → 5px */
            border-width: 1px; /* 2px → 1px */
          }
          /* #pyramid-blockの子要素1 */
          #top-controls {
            order: 3;
          }
          /* #pyramid-blockの子要素2 */
          #pyramid-container {
            order: 1;
          }
          /* #pyramid-blockの子要素3 */
          #source_container {
            order: 2;
            font-size:75%;
          }
          #cho-buttons {
            flex-direction: column;
            max-width: 70%;
            margin: 0 auto;
            justify-content: center;
          }
        }

        /* 700px未満のスマホ用 */
        @media screen and (max-width: 700px) {
          #animation-btn-block {
            gap: 5px;
          }
          #animation-radio-buttons {
            flex-direction: column;
            gap: 5px;
          }
          #animation-btn-group1 {
            flex-direction: column;
            gap: 10px;
          }
          #animation-btn-group1 button {
            padding: 4px 16px;
          }
          #animation-btn-group2 {
            flex-direction: column-reverse;
            gap: 10px;
          }
          #animation-btn-group2 button {
            padding: 4px 27px;
          }
        }

        /* 585px未満のスマホ用 */
        @media screen and (max-width: 585px) {
          #animation-execute-section {
            flex-direction: column;
            gap: 10px;
            align-items: flex-start;
          }
          #animation-settings-block {
            min-width: auto !important;
            width: 100% !important;
          }
          #animation-btn-block {
            gap: 5px;
            width: 100% !important;
            align-items: flex-start !important;
            justify-content: flex-start !important;
          }
          #animation-btn-group1 {
            flex-direction: row;
            gap: 5px;
          }
          #animation-btn-group1 button {
            padding: 4px 16px;
          }
          #animation-btn-group2 {
            flex-direction: row;
            gap: 5px;
          }
          #animation-btn-group2 button {
            padding: 4px 16px;
          }
        }

        /* さらに小さなスマホ用：額縁を完全に削除 */
        @media screen and (max-width: 480px) {
          #main {
            padding: 0;
          }
          h1 {
            font-size: 120%;
          }
          h2 {
            font-size: 95%;
          }

          #container-flex {
            padding: 0;
          }
          #pyramid-container {
            padding: 0; /* 額縁を完全に削除 */
            margin: 5px auto;
            background: transparent; /* 背景も削除 */
            box-shadow: none; /* 影も削除 */
            border-radius: 0; /* 角の丸みも削除 */
          }

          #pyramid-container::before {
            display: none; /* 内側枠も削除 */
          }
        }
        @media screen and (max-width: 479px) {
          div#cho_list {
            text-align: left;
          }
        }
      </style>
    </head>
    <body
      onload="on_page_load()"
      style="
        background: #f5f5dc;
        min-height: 100vh;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      "
    >
      <!--旧システムコード対応-->
      <input type="hidden" id="save" />
      <input type="hidden" id="clear" checked />

      <div id="main">
        <div id="header" data-html2canvas-ignore="true">
          <a href="#" data-tooltip-id="new_info_tooltip">
            ><span style="color: red; font-size: 100%">New!</span>
          </a>
          <a href="#" class="header" data-tooltip-id="about_site_tooltip">
            >このサイトについて
          </a>
          <a
            href="#"
            class="header"
            data-tooltip-id="info_pyramid_size_tooltip"
          >
            >人口ピラミッドと人口の増減について
          </a>
          <a
            href="#"
            class="header"
            data-tooltip-id="about_browser_tooltip"
          >
            >端末、ブラウザの対応状況について
          </a>
          <a href="#" class="header" data-tooltip-id="about_data_source_tooltip"
            >>データの出典について</a
          >
        </div>

        <div id="title-container">
          <h1 id="h1" data-html2canvas-ignore="true">横浜市の人口ピラミッド</h1>
          <br />
          <h2 id="h2"><span id="h2-text">横浜市(平成28年1月1日現在)</span></h2>
        </div>

        <!-- データ読み込み中の表示 -->
        <div
          id="loading-container"
          style="
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
            max-width: 100%;
          "
        >
          <div style="font-size: 18px; margin-bottom: 20px">
            <div
              style="
                display: inline-block;
                width: 20px;
                height: 20px;
                border: 3px solid #f8f9fa;
                border-top: 3px solid #4a90e2;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin-right: 10px;
              "
            ></div>
            データを読み込み中です...
          </div>
          <div style="font-size: 14px; color: #adb5bd">
            人口統計データを読み込んでいます。しばらくお待ちください。
          </div>
        </div>

        <div id="container-flex" style="display: none">
          <div id="pyramid-block">
            <!-- 上部コントロール -->
            <div id="top-controls" data-html2canvas-ignore="true">
              <!-- アニメーション用コントロール（通常は非表示） -->
              <div id="animation-controls">
                <!-- 上段: アニメーションの種類ブロック -->
                <div id="animation-type-section">
                  <span
                    style="
                      font-weight: bold;
                      min-width: 2em;
                      text-align: center;
                    "
                    >種類</span
                  >
                  <div id="animation-radio-buttons">
                    <!-- 左側のラジオボタングループ -->
                    <div id="animation-radio-buttons-left"
                         style="
                           display: flex;
                           align-items: center;
                           padding: 5px 10px;
                           border: 1px solid #ced4da;
                           border-radius: 4px;
                         "
                    >
                      <label style="margin-right: 1em">
                        <input
                          type="radio"
                          name="animation-type-inline"
                          value="direct"
                          checked
                        />
                        <span>通常タイプ</span>
                      </label>
                      <label>
                        <input
                          type="radio"
                          name="animation-type-inline"
                          value="interpolation"
                        />
                        <span>伸び縮みタイプ</span>
                      </label>
                    </div>
                    <!-- 右側のラジオボタングループ -->
                    <div id="animation-radio-buttons-right"
                         style="
                           display: flex;
                           align-items: center;
                           padding: 5px 10px;
                           border: 1px solid #ced4da;
                           border-radius: 4px;
                         "
                    >
                      <label style="margin-right: 1.5em">
                        <input
                          type="radio"
                          name="animation-mode"
                          value="age-composition"
                          checked
                        />
                        <span>年齢構成</span>
                      </label>
                      <label>
                        <input
                          type="radio"
                          name="animation-mode"
                          value="age-composition-population"
                        />
                        <span>年齢構成 + 人口増減</span>
                      </label>
                    </div>
                  </div>
                </div>
                <!-- 下段: スライドバー・ボタンブロック -->
                <div
                  id="animation-execute-section"
                  style="display: flex; justify-content: flex-start"
                >
                  <!-- 左側: スライドバーブロック（上下2段） -->
                  <div id="animation-settings-block">
                    <!-- 上段: 速度調節 -->
                    <div style="display: flex; align-items: center; gap: 10px">
                      <span
                        style="
                          font-weight: bold;
                          min-width: 2em;
                          text-align: center;
                        "
                        >速度:</span
                      >
                      <span>ゆっくり</span>
                      <input
                        type="range"
                        id="animation-speed"
                        min="50"
                        max="500"
                        value="200"
                        style="width: 120px"
                      />
                      <span>早く</span>
                    </div>
                    <!-- 下段: 進捗スライダー -->
                    <div
                      id="animation-progress-controls"
                      style="
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        position: relative;
                      "
                    >
                      <span
                        style="
                          font-weight: bold;
                          min-width: 2em;
                          text-align: center;
                        "
                        >進行状況:</span
                      >
                      <input
                        type="range"
                        id="animation-progress"
                        min="0"
                        max="100"
                        value="0"
                        style="width: 150px"
                      />
                      <span id="progress-display">0%</span>
                      <!-- ツールチップ -->
                      <div
                        id="slider-tooltip"
                        style="
                          position: absolute;
                          top: -40px;
                          left: 50%;
                          transform: translateX(-50%);
                          background: rgba(0, 0, 0, 0.8);
                          color: white;
                          padding: 5px 10px;
                          border-radius: 4px;
                          font-size: 12px;
                          white-space: nowrap;
                          display: none;
                          z-index: 1000;
                          pointer-events: none;
                        "
                      >
                        基準日: 準備中
                      </div>
                    </div>
                  </div>
                  <!-- 右側: ボタンブロック -->
                  <div id="animation-btn-block">
                    <div id="animation-btn-group1">
                      <button
                        type="button"
                        id="start-animation-btn"
                        onclick="startAnimationFromControls()"
                      >
                        開始
                      </button>
                      <button
                        type="button"
                        id="pause-animation-btn"
                        onclick="pauseAnimationFromControls()"
                      >
                        一時停止
                      </button>
                    </div>
                    <div id="animation-btn-group2">
                      <button
                        type="button"
                        id="resume-animation-btn"
                        onclick="resumeAnimationFromControls()"
                      >
                        再開
                      </button>
                      <button
                        type="button"
                        id="stop-animation-btn"
                        onclick="stopAnimationFromControls()"
                      >
                        終了
                      </button>
                    </div>
                    <!-- ツールチップアイコン -->
                    <a
                      href="#"
                      class="info-icon-right"
                      data-tooltip-id="info_animation_tooltip"
                      ><img src="./image/tooltip-icon.png" class="small-icon"
                    /></a>
                  </div>
                </div>
              </div>
              <!-- #animation-controls ここまで -->
              <!-- 地域別人口ピラミッドの町丁名指定へのリンク -->
              <div id="link">
                <a href="#" onclick="showChoSection(); return false;"> 地域別人口ピラミッドのための町丁名の指定 </a>
                <span
                  class="info-icon-right"
                  data-tooltip-id="cho_link_tooltip"
                  style="cursor: pointer"
                >
                  <img src="./image/tooltip-icon.png" class="small-icon"
                /></span>
              </div>
              <!-- #link ここまで -->
              <!-- #市区、年月セレクトボックス -->
              <div id="select-controls">
                <div id="comment" data-html2canvas-ignore="true"></div>
                <div id="hitoku" data-html2canvas-ignore="true">
                  数字が著しく小さいために秘匿処理(統計表では"X"表記)されたデータがありました。ここでは便宜上"X"を0(ゼロ)として取り扱っています。
                </div>
                <!-- 市区・年月セレクトボックス、動画ボタン -->
                <div
                  style="
                    display: flex;
                    align-items: flex-start;
                    justify-content: flex-end;
                    gap: 10px;
                    flex-wrap: wrap;
                  "
                >
                  <!-- 市区セレクトボックス -->
                  <select onChange="change_shiku()" name="shiku" id="shiku">
                    <option selected="selected" value="age">横浜市</option>
                    <option value="tsurumi">鶴見区</option>
                    <option value="kanagawa">神奈川区</option>
                    <option value="nishi">西区</option>
                    <option value="naka">中区</option>
                    <option value="minami">南区</option>
                    <option value="konan">港南区</option>
                    <option value="hodogaya">保土ケ谷区</option>
                    <option value="asahi">旭区</option>
                    <option value="isogo">磯子区</option>
                    <option value="kanazawa">金沢区</option>
                    <option value="kohoku">港北区</option>
                    <option value="midori">緑区</option>
                    <option value="aoba">青葉区</option>
                    <option value="tsuzuki">都筑区</option>
                    <option value="totsuka">戸塚区</option>
                    <option value="sakae">栄区</option>
                    <option value="izumi">泉区</option>
                    <option value="seya">瀬谷区</option>
                  </select>
                  <div
                    id="shiku_year_container"
                    style="
                      display: flex;
                      flex-direction: column;
                      align-items: center;
                      justify-content: center;
                      gap: 2px;
                      flex-wrap: nowrap;
                    "
                  >
                    <!-- 年月セレクトボックス（市区ピラミッド用） -->
                    <select
                      onChange="change_shiku_year()"
                      name="shiku_year"
                      id="shiku_year"
                    >
                      <!-- 動的オプション読み込み用プレースホルダー -->
                      <option value="new" selected>　　 最新</option>
                    </select>
                    <!-- 年月セレクトボックス（町丁別ピラミッド用） -->
                    <select
                      onChange="change_cho_year()"
                      name="cho_year"
                      id="cho_year"
                    >
                      <option value="202109">令和６年9月30日現在</option>
                      <option value="202109">令和５年9月30日現在</option>
                      <option value="202109">令和４年9月30日現在</option>
                      <option value="202109">令和３年9月30日現在</option>
                      <option value="202009">令和２年9月30日現在</option>
                      <option value="201909">
                        平成31・令和元年9月30日現在
                      </option>
                      <option value="201809">平成30年9月30日現在</option>
                      <option value="201709">平成29年9月30日現在</option>
                      <option value="201609">平成28年9月30日現在</option>
                      <option value="201509">平成27年9月30日現在</option>
                      <option value="201409">平成26年9月30日現在</option>
                      <option value="201309">平成25年9月30日現在</option>
                      <option value="201209">平成24年9月30日現在</option>
                      <option value="201109">平成23年9月30日現在</option>
                      <option value="201009">平成22年9月30日現在</option>
                      <option value="200909">平成21年9月30日現在</option>
                      <option value="200809">平成20年9月30日現在</option>
                      <option value="200709">平成19年9月30日現在</option>
                      <option value="200609">平成18年9月30日現在</option>
                      <option value="200509">平成17年9月30日現在</option>
                      <option value="200409">平成16年9月30日現在</option>
                      <option value="200309">平成15年9月30日現在</option>
                      <option value="200209">平成14年9月30日現在</option>
                      <option value="200109">平成13年9月30日現在</option>
                      <option value="200009">平成12年9月30日現在</option>
                      <option value="199909">平成11年9月30日現在</option>
                      <option value="199809">平成10年9月30日現在</option>
                    </select>
                    <!-- スライドバー1（市区ピラミッド用） -->
                    <div
                      id="shiku-year-slider-container"
                      style="display: none; margin-top: 5px; text-align: right"
                    >
                      <div
                        style="
                          display: inline-flex;
                          align-items: center;
                          gap: 0px;
                          font-size: 12px;
                        "
                      >
                        <span>過去</span>
                        <input
                          type="range"
                          id="shiku-year-slider"
                          min="0"
                          max="100"
                          value="0"
                          style="width: 190px"
                        />
                        <span>将来</span>
                        <!-- 機能的に必要：削除しないでください -->
                        <span
                          id="shiku-year-slider-display"
                          style="display: none"
                          >将来</span
                        >
                      </div>
                    </div>

                    <!-- スライドバー2（町丁別ピラミッド用） -->
                    <div
                      id="cho-year-slider-container"
                      style="display: none; margin-top: 5px; text-align: right"
                    >
                      <div
                        style="
                          display: inline-flex;
                          align-items: center;
                          gap: 0px;
                          font-size: 12px;
                        "
                      >
                        <span>過去</span>
                        <input
                          type="range"
                          id="cho-year-slider"
                          min="0"
                          max="100"
                          value="0"
                          style="width: 190px"
                        />
                        <span>最新</span>
                        <!-- 機能的に必要：削除しないでください -->
                        <span id="cho-year-slider-display" style="display: none"
                          >最新</span
                        >
                      </div>
                    </div>
                  </div>
                  <!-- 動画ボタンとツールチップアイコン -->
                  <div id="doga_button">
                    <!-- 動画ボタン -->
                    <button
                      onClick="toggleAnimationPanel()"
                      name="animation"
                      type="button"
                      id="doga"
                    >
                      動画
                    </button>
                    <!-- ツールチップアイコン -->
                    <a
                      href="#"
                      class="info-icon-right"
                      data-tooltip-id="doga_button_tooltip"
                      ><img src="./image/tooltip-icon.png" class="small-icon"
                    /></a>
                  </div>
                </div>
              </div>
              <!-- #select-controls ここまで -->
            </div>
            <!-- #top-controls ここまで -->

            <!-- #SVG描画領域 -->
            <div id="pyramid-container">
              <!-- 基本データ(人口と3区分別人口) -->
              <div id="basic_data">
                <div id="jinko_sosu">
                  <span class="tr">
                    <span class="td"></span>
                    <span class="td">人口</span>
                    <span class="td" id="sosu">xxx,xxx人</span>
                    <span class="td"></span>
                  </span>
                  <span class="tr">
                    <span class="td"></span>
                    <span class="td">男</span>
                    <span class="td" id="male">xxx,xxx人</span>
                    <span class="td"></span>
                  </span>
                  <span class="tr">
                    <span class="td"></span>
                    <span class="td">女</span>
                    <span class="td" id="female">xxx,xxx人</span>
                    <span class="td"></span>
                  </span>
                </div>
                <!--jinko_sosu ここまで-->
                <div id="select" data-html2canvas-ignore="true">
                  <select id="kubun_unit" onchange="kubunDisplay()">
                    <option value="構成比" selected="selected">
                      年齢3区分別構成比
                    </option>
                    <option value="人口">年齢3区分別人口</option>
                    <option value="非表示">年齢3区分別人口/構成比非表示</option>
                  </select>
                  <span
                    id="info_3kubun"
                    class="info-icon-3kubun"
                    data-tooltip-id="info_3kubun_tooltip"
                    style="cursor: pointer"
                    ><img src="./image/tooltip-icon.png" class="small-icon"
                  /></span>
                  <input
                    id="kubun_button"
                    type="submit"
                    value="3区分表示"
                    onclick="kubunSelectDisp()"
                  />
                  <input id="kubun_selected" type="hidden" value="" />
                </div>
                <div id="nenrei_3kubun">
                  <span class="tr">
                    <span class="td">年 齢 区 分</span>
                    <span class="td">総数</span>
                    <span class="td">男</span>
                    <span class="td">女</span>
                  </span>
                  <span class="tr">
                    <span class="td">
                      <span id="heigher">75</span>
                      歳以上
                    </span>
                    <span class="td" id="ku3_sosu">xxx,xxx人</span>
                    <span class="td" id="ku3_male">xxx,xxx人</span>
                    <span class="td" id="ku3_female">xxx,xxx人</span>
                  </span>
                  <span class="tr">
                    <span class="td" id="kubun2_title">
                      <div class="age-cell-container">
                        <span class="age-text">　</span>
                        <div class="age-input-container">
                          <span class="age-display" id="startAgeDisplay"
                            >15</span
                          >
                          <input
                            type="number"
                            id="smiddle"
                            class="age-input"
                            value="15"
                            min="0"
                            max="99"
                            onchange="kubunChange(); updateAgeDisplay('start', this.value)"
                            oninput="validateAgeInput(this); updateAgeDisplay('start', this.value)"
                            title="開始年齢（0-99歳）"
                          />
                        </div>
                        <span class="age-text">〜</span>
                        <span class="age-text">　</span>
                        <div class="age-input-container">
                          <span class="age-display" id="endAgeDisplay">64</span>
                          <input
                            type="number"
                            id="emiddle"
                            class="age-input"
                            value="64"
                            min="0"
                            max="99"
                            onchange="kubunChange(); updateAgeDisplay('end', this.value)"
                            oninput="validateAgeInput(this); updateAgeDisplay('end', this.value)"
                            title="終了年齢（0-99歳）"
                          />
                        </div>
                        <span class="age-text">歳</span>
                      </div>
                    </span>
                    <span class="td" id="ku2_sosu">xx,xxx人</span>
                    <span class="td" id="ku2_male">xx,xxx人</span>
                    <span class="td" id="ku2_female">xx,xxx人</span>
                  </span>
                  <span class="tr">
                    <span class="td">
                      0〜
                      <span id="lower">14</span>
                      歳
                    </span>
                    <span class="td" id="ku1_sosu">xx,xxx人</span>
                    <span class="td" id="ku1_male">xx,xxx人</span>
                    <span class="td" id="ku1_female">xx,xxx人</span>
                  </span>
                </div>
                <!--#nenrei_3kuibun ここまで-->
              </div>
              <!--#basic_data ここまで-->
            </div>
            <!-- #pyramid-container ここまで -->

            <!-- 現在の年次表示 -->
            <div
              id="current-year-display"
              style="
                position: fixed;
                top: 10px;
                left: 10px;
                background: rgba(0, 0, 0, 0.8);
                color: white;
                padding: 10px;
                border-radius: 5px;
                z-index: 1000;
                font-size: 18px;
                font-weight: bold;
                display: none;
              "
            >
              準備中...
            </div>

            <!--年齢別人口の出典-->
            <div id="source_container">
              <span id="source" data-html2canvas-ignore="true">
                年齢別人口(<a
                  href="http://www.city.yokohama.lg.jp/ex/stat/jinko/age/new/tsurumi-j.html"
                  >http://www.city.yokohama.lg.jp/ex/stat/jinko/age/new/tsurumi-j.html</a
                >)
              </span>
            </div>
            <!-- #source_container ここまで -->

            <!-- 町丁別人口ピラミッドボタンと町丁名リスト -->
            <div id="cho" data-html2canvas-ignore="true">
              <a href="link"></a>
              <form name="chobetsu">
                <div id="cho-buttons">
                  <input
                    type="button"
                    value="町丁別人口ピラミッド"
                    onClick="cho_pyramid_button()"
                  />
                  <input
                    type="button"
                    value="区全体の人口ピラミッド"
                    onClick="ku_pyramid_button()"
                  />
                  <input
                    type="button"
                    value="クリア"
                    onClick="checkbox_clear()"
                  />
                  <input type="hidden" value="shiku" id="mode" />
                  <a
                    href="#here"
                    class="info-icon-bottom"
                    data-tooltip-id="info_cho_pyramid_tooltip"
                    ><img src="./image/tooltip-icon.png" class="small-icon"
                  /></a>
                </div>
                <div id="cho_list">
                  <!--ここに町丁名リストが入る-->
                </div>
              </form>
            </div>
            <!-- #cho ここまで -->
          </div>
          <!-- pyramid-block ここまで -->

          <!-- 左端に縦に並ぶコントロール -->
          <div class="left-controls" data-html2canvas-ignore="true">
            <div
              id="option"
              class="control-group"
              data-html2canvas-ignore="true"
            >
              <h3>
                スクリーンショット
                <a
                  href="#here"
                  data-tooltip-id="screen_shot_tooltip"
                  ><img src="./image/tooltip-icon.png" class="small-icon" /></a
                ><a name="screen_shot_tooltip"></a>
              </h3>
              <div class="button-group">
                <button onClick="screen_shot()" id="screen_shot_button">
                  スクリーンショット
                </button>
                <span id="dialog"></span>
              </div>
            </div>

            <div class="control-group">
              <h3>縦横サイズ変更</h3>
              <div class="button-group">
                <button id="uin">＋ 拡大</button>
                <button id="uout">－ 縮小</button>
              </div>
              <div class="radio-group">
                <label>
                  <input
                    type="radio"
                    name="unitType"
                    id="unitsize"
                    value="width"
                    checked
                  />
                  <span>横</span>
                </label>
                <label>
                  <input
                    type="radio"
                    name="unitType"
                    id="barheight"
                    value="height"
                  />
                  <span>縦</span>
                </label>
              </div>
            </div>

            <div class="control-group">
              <h3>ズーム</h3>
              <div class="button-group">
                <button id="zin">＋ 拡大</button>
                <button id="zout">－ 縮小</button>
              </div>
              <label>倍率: <span id="scaleLabel">100%</span></label>
            </div>

            <div class="control-group">
              <h3>表示切替え</h3>
              <div class="button-group">
                <button onclick="toggleNumbers()">人数表示ON/OFF</button>
                <button onclick="toggleGrid()">グリッド表示ON/OFF</button>
                <button onclick="toggleAgeGroup()" id="age_group_toggle">
                  年齢３区分別等表示ON/OFF
                </button>
              </div>
            </div>
          </div>
          <!-- #left-controls ここまで -->
        </div>
        <!-- #container-flex ここまで -->
      </div>
      <!-- id=main ここまで -->

      <!-- スクリーンショット描画領域 -->
      <div id="screen_shot_section"></div>
      <!-- #screen_shot_section ここまで -->

      <!-- フッタ部分 -->
      <div
        class="footer"
        id="footer"
        data-html2canvas-ignore="true"
        style="display: none"
      >
        <hr class="margin-top margin-bottom" />
        <!-- ここから著作権情報と連絡先 -->
        <address>
          <span style="display: block">
            <span class="block"> INUZUKA Katsu </span
            ><span> - 2016年12月21日 作成 </span
            ><span> - 2025年9月18日 更新 </span>
          </span>
          <span style="display: block">
            <span class="block">
              問い合わせ、連絡先（不具合の報告、改良のアイディアをお寄せください.） </span
            ><span class="block">
              -
              <a href="mailto:inuzuka0601&#64;gmail.com"
                >inuzuka0601&#64;gmail.com</a
              >
            </span>
          </span>
          <span> &copy;2016-2024 INUZUKA Katsu. </span>
          <span> All rights reserved. </span>
        </address>
        <!-- ここまで著作権情報と連絡先 -->
      </div>
      <!-- ここまでフッタ部分 -->

      <script>
        // currentRendererをwindow.pyramidRendererに統一
        let currentRenderer = null;
        let isSVGMode = true;
        let currentOptions = {
          showNumbers: true,
          showGrid: true,
        };

        // 初期化
        document.addEventListener("DOMContentLoaded", function () {
          // アニメーション進行スライダーの初期化
          setupAnimationProgressSlider();

          // セレクトボックスのイベントリスナーを設定
          //const demoDataSelect = document.getElementById("demoData");
          //demoDataSelect.addEventListener("change", changeDemoData);
          // 初期データの読み込み
          //loadDemoData();
          // バーの高さスライダーのイベントリスナーを設定
          //const barHeightSlider = document.getElementById('barHeightSlider');
          //barHeightSlider.addEventListener('input', updateBarHeightValue);
        });

        // 縦横サイズの変更
        const uin = document.getElementById("uin");
        const uout = document.getElementById("uout");
        const radio = document.getElementById("unitsize");
        uin.addEventListener("click", () => {
          if (radio.checked) {
            let unitSize = window.pyramidRenderer.options.unitSize * 1.01;
            window.pyramidRenderer.resize({ unitSize: unitSize });
          } else {
            let barHeight = window.pyramidRenderer.options.barHeight * 1.01;
            window.pyramidRenderer.resize({ barHeight: barHeight });
          }
        });
        uout.addEventListener("click", () => {
          if (radio.checked) {
            let unitSize = window.pyramidRenderer.options.unitSize * 0.99;
            window.pyramidRenderer.resize({ unitSize: unitSize });
          } else {
            let barHeight = window.pyramidRenderer.options.barHeight * 0.99;
            window.pyramidRenderer.resize({ barHeight: barHeight });
          }
        });

        // ズームによるピラミッドサイズの変更
        const zin = document.getElementById("zin");
        const zout = document.getElementById("zout");
        const zoom = document.getElementById("scaleLabel");
        let scale = 1;
        zin.addEventListener("click", () => {
          scale = Math.min(1.5, scale + 0.01);
          zoom.value = scale;
          window.pyramidRenderer.resize({ scale: scale });
          zoom.textContent = (scale * 100).toFixed(0) + "%";
        });
        zout.addEventListener("click", () => {
          scale = Math.max(0.25, scale - 0.01);
          zoom.value = scale;
          window.pyramidRenderer.resize({ scale: scale });
          zoom.textContent = (scale * 100).toFixed(0) + "%";
        });

        function changePyramidSize() {
          const scale = parseFloat(
            document.getElementById("pyramidSize").value
          );
          if (window.pyramidRenderer) {
            window.pyramidRenderer.resize({ scale: scale });
          }
        }

        // 人数表示の切り替え
        function toggleNumbers() {
          currentOptions.showNumbers = !currentOptions.showNumbers;
          if (window.pyramidRenderer) {
            window.pyramidRenderer.updateOptions({
              showNumbers: currentOptions.showNumbers,
            });
          }
          localStorage_set("showNumbers", currentOptions.showNumbers);
        }

        // グリッド表示の切り替え
        function toggleGrid() {
          currentOptions.showGrid = !currentOptions.showGrid;
          if (window.pyramidRenderer) {
            window.pyramidRenderer.updateOptions({
              showGrid: currentOptions.showGrid,
            });
          }
        }

        // 年齢3区分表示の切り替え
        function toggleAgeGroup() {
          const basicData = document.getElementById("basic_data");
          const toggleButton = document.getElementById("age_group_toggle");

          if (basicData.style.display === "none") {
            // 非表示の場合は表示に
            basicData.style.display = "";　//初期状態に戻す。ここでblockにするとレスポンシブデザインが無効になってしまう。
            toggleButton.textContent = "年齢３区分別等表示ON/OFF";
          } else {
            // 表示の場合は非表示に
            basicData.style.display = "none";
            toggleButton.textContent = "年齢３区分別等表示ON/OFF";
          }
        }

        // ピラミッドの描画
        function renderPyramid(data, animeMode) {
          let isAnimation = false;
          if (animeMode != undefined) {
            isAnimation = true;
          }

          console.log(
            "renderPyramid 関数定義完了",
            "isAnimation:",
            isAnimation
          );
          if (!isSVGMode) {
            document.getElementById("pyramid-container").innerHTML =
              '<p style="text-align: center; padding: 50px;">このデモではSVG描画のみ対応しています</p>';
            return;
          }
          console.log("rout3");
          //const options = {
          //    ...currentOptions,
          //    scaleMode: document.getElementById('scaleMode').value
          //};
          console.log("rout4");
          try {
            if (window.pyramidRenderer) {
              // 既存のレンダラーがある場合は更新（zoomScaleを保持）
              console.log("既存レンダラーを更新（zoomScale保持）");
              console.log(
                "更新前のzoomScale:",
                window.pyramidRenderer.options.zoomScale
              );
              window.pyramidRenderer.updateData(data, animeMode);
              console.log(
                "更新後のzoomScale:",
                window.pyramidRenderer.options.zoomScale
              );
            } else {
              // レンダラーが存在しない場合は新しいレンダラーを作成
              console.log("新しいレンダラーを作成");
              window.pyramidRenderer = new PyramidSVGRenderer(
                "pyramid-container",
                data
              );
            }
            //document.getElementById('status').textContent =
            //    `SVG描画エンジンが有効です - ${data.shiku} (${data.kijunbi})`;

            // SVG描画完了後に表示を切り替え（アニメーション中は除く）
            if (!isAnimation) {
              setTimeout(() => {
                // ローディング表示を非表示に
                const loadingContainer =
                  document.getElementById("loading-container");
                if (loadingContainer) {
                  loadingContainer.style.display = "none";
                }

                // メインコンテンツを表示
                const containerFlex = document.getElementById("container-flex");
                if (containerFlex) {
                  containerFlex.style.display = "flex";
                }
                const footer = document.getElementById("footer");
                if (footer) {
                  footer.style.display = "block";
                }
                // h2タイトルのフォントサイズを調整
                adjust_title_size("h2-text");
              }, 100);
            }
          } catch (error) {
            console.error("描画に失敗しました:", error);
            document.getElementById("pyramid-container").innerHTML =
              '<p style="text-align: center; padding: 50px; color: #dc3545;">描画エラーが発生しました</p>';
          }
        }
        // 定義完了後の確認
        console.log("スクリプト読み込み完了時:");
        console.log("loadDemoData:", typeof loadDemoData);
        console.log("renderPyramid:", typeof renderPyramid);

        // アニメーション制御のイベントリスナー
        document.addEventListener("DOMContentLoaded", function () {
          // UI同期機能を初期化
          initializeUISynchronizer();

          const speedSlider = document.getElementById("animation-speed");
          const barDurationSlider = document.getElementById(
            "bar-animation-duration"
          );

          if (speedSlider) {
            speedSlider.addEventListener("input", function () {
              const sliderValue = parseInt(this.value);
              // スライダー値を逆転（50-500 → 500-50）
              const actualSpeed = 550 - sliderValue; // 50+500-sliderValue

              const speedDisplay = document.getElementById("speed-display");
              if (speedDisplay) {
                speedDisplay.textContent = actualSpeed + "ms";
              }

              // アニメーションが初期化されている場合のみ速度を設定
              if (
                window.streamingAnimation &&
                window.streamingAnimation.setAnimationSpeed
              ) {
                window.streamingAnimation.setAnimationSpeed(actualSpeed);
                console.log(
                  `アニメーション速度を設定: スライダー値=${sliderValue} → 実際の速度=${actualSpeed}ms`
                );
              } else {
                console.log(
                  `アニメーション未初期化: 速度設定をスキップ (スライダー値=${sliderValue} → 実際の速度=${actualSpeed}ms)`
                );
              }
            });
          }

          if (barDurationSlider) {
            barDurationSlider.addEventListener("input", function () {
              const duration = parseInt(this.value);
              const barDurationDisplay = document.getElementById(
                "bar-duration-display"
              );
              if (barDurationDisplay) {
                barDurationDisplay.textContent = duration + "ms";
              }

              // アニメーションが初期化されている場合のみ期間を設定
              if (
                window.streamingAnimation &&
                window.streamingAnimation.setBarAnimationDuration
              ) {
                window.streamingAnimation.setBarAnimationDuration(duration);
                console.log(`バーアニメーション期間を設定: ${duration}ms`);
              } else {
                console.log(
                  `アニメーション未初期化: バーアニメーション期間設定をスキップ (${duration}ms)`
                );
              }
            });
          }
        });

        // グローバルエラーハンドラー
        window.addEventListener("error", function (event) {
          console.error("グローバルエラーが発生しました:", event.error);
          console.error("エラー詳細:", {
            message: event.message,
            filename: event.filename,
            lineno: event.lineno,
            colno: event.colno,
            error: event.error,
          });
          alert("予期しないエラーが発生しました: " + event.message);
        });

        // 未処理のPromise拒否をキャッチ
        window.addEventListener("unhandledrejection", function (event) {
          console.error("未処理のPromise拒否が発生しました:", event.reason);
          alert("非同期処理でエラーが発生しました: " + event.reason);
        });

        // アニメーションコントロールの表示切り替え
        function showAnimationControls() {
          const selectLinkElement        = document.getElementById("link");
          const selectControlsElement    = document.getElementById("select-controls");
          const animationControlsElement = document.getElementById("animation-controls");
          const topControlsElement       = document.getElementById("top-controls");

          // 要素を非表示にするが、レイアウト上の高さは保持
          // hiddenでは一瞬の間が空くため、opacity=0で即時に非表示にする
          selectLinkElement.style.opacity = "0";
          selectLinkElement.style.visibility = "hidden";
          selectControlsElement.style.opacity = "0";
          selectControlsElement.style.visibility = "hidden";

          // アニメーションコントロールを表示
          animationControlsElement.style.visibility = "visible";
          animationControlsElement.style.opacity = "1";

          // 進捗スライダーを初期化
          setupAnimationProgressSlider();
        }

        function hideAnimationControls() {
          const selectLinkElement        = document.getElementById("link");
          const selectControlsElement    = document.getElementById("select-controls");
          const animationControlsElement = document.getElementById("animation-controls");
          const topControlsElement       = document.getElementById("top-controls");
          const shikuSelectControl       = document.getElementById("shiku");

          // アニメーションコントロールを非表示
          animationControlsElement.style.visibility = "hidden";
          animationControlsElement.style.opacity = "0";

          // 元の状態に戻す
          if (shikuSelectControl.value != "age") {
            selectLinkElement.style.opacity = "1";
            selectLinkElement.style.visibility = "visible";
          }
          selectControlsElement.style.opacity = "1";
          selectControlsElement.style.visibility = "visible";
                    
        }

        // アニメーション開始
        async function startAnimationFromControls() {
          const animationType = document.querySelector(
            'input[name="animation-type-inline"]:checked'
          ).value;
          // 速度は後でアニメーション設定時に確実に読み取る

          // デバッグ: 現在のモードを確認
          const currentMode = get_pyramid_mode();
          console.log(
            "startAnimationFromControls: 現在のモード =",
            currentMode
          );
          console.log(
            "startAnimationFromControls: mode要素の値 =",
            document.getElementById("mode").value
          );
          console.log(
            "startAnimationFromControls: animationType =",
            animationType
          );

          // 新設のラジオボタンの状態を読み取って面積モードを決定
          const animationMode = document.querySelector(
            'input[name="animation-mode"]:checked'
          ).value;
          const useVariableAreaMode =
            animationMode === "age-composition-population";
          console.warn(
            "ラジオボタン選択: アニメーションモード =",
            animationMode
          );
          console.warn("可変面積モード =", useVariableAreaMode);

          // アニメーション設定を更新
          if (window.streamingAnimation) {
            // 速度設定（スライダーの現在値を確実に読み取り）
            const sliderValue = parseInt(
              document.getElementById("animation-speed").value
            );
            const currentSpeed = 550 - sliderValue; // スライダー値を逆転
            window.streamingAnimation.animationSpeed = currentSpeed;
            window.streamingAnimation.useInterpolation =
              animationType === "interpolation";
            window.streamingAnimation.interpolationDuration = 1000;
            window.streamingAnimation.useVariableAreaMode = useVariableAreaMode;

            // デバッグ: 設定値を確認
            console.warn("アニメーション設定更新:");
            console.warn("  - animationType:", animationType);
            console.warn("  - sliderValue:", sliderValue);
            console.warn("  - animationSpeed:", currentSpeed);
            console.warn(
              "  - useInterpolation:",
              window.streamingAnimation.useInterpolation
            );
            console.warn(
              "  - useVariableAreaMode:",
              window.streamingAnimation.useVariableAreaMode
            );
          }

          // アニメーション開始
          if (useVariableAreaMode) {
            // 可変面積モード: 事前に全データを取得し最大総人口を計算。それを基準として各年のズームスケールを算出する。
            await startAnimationWithVariableAreaMode();
          } else {
            // 面積固定モード（補間・非補間共通）
            // 面積固定モードを有効化
            window.streamingAnimation.useVariableAreaMode = false;
            if (window.streamingAnimation) {
              await window.streamingAnimation.startStreamingAnimation();
            } else {
              console.error("ストリーミングアニメーションが利用できません");
              alert("ストリーミングアニメーションが利用できません");
            }
          }

          // アニメーション開始後にスライダーを有効化
          updateSliderState();
        }

        // 可変面積モードアニメーション開始（新しいzoomScaleモード）
        async function startAnimationWithVariableAreaMode() {
          try {
            // データ取得中の表示
            showDataLoadingMessage();

            const shiku = get_selected_shiku();
            console.log("可変面積モードアニメーション開始: shiku =", shiku);

            // 可変面積モードを有効化
            window.streamingAnimation.useVariableAreaMode = true;

            // データ取得完了の表示を非表示
            hideDataLoadingMessage();

            // アニメーション開始（StreamingAnimationManager内で全年次データ取得と最大総人口算出を行う）
            if (window.streamingAnimation) {
              await window.streamingAnimation.startStreamingAnimation();
            } else {
              console.error("ストリーミングアニメーションが利用できません");
              alert("ストリーミングアニメーションが利用できません");
            }

            // アニメーション開始後にスライダーを有効化
            updateSliderState();
          } catch (error) {
            console.error("人口変化反映アニメーション開始エラー:", error);
            hideDataLoadingMessage();
            alert(
              "データの取得に失敗しました。通常モードでアニメーションを開始します。"
            );
            // エラー時は面積固定モードで開始
            window.streamingAnimation.useVariableAreaMode = false;
            if (window.streamingAnimation) {
              await window.streamingAnimation.startStreamingAnimation();
            } else {
              console.error("ストリーミングアニメーションが利用できません");
              alert("ストリーミングアニメーションが利用できません");
            }

            // エラー時でもアニメーション開始後にスライダーを有効化
            updateSliderState();
          }
        }

        // データ取得中の表示
        function showDataLoadingMessage() {
          const loadingDiv = document.createElement("div");
          loadingDiv.id = "data-loading-message";
          loadingDiv.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            z-index: 10001;
            text-align: center;
          `;
          loadingDiv.innerHTML = `
            <div style="margin-bottom: 15px;">
              <div style="
                width: 40px;
                height: 40px;
                border: 4px solid #f3f3f3;
                border-top: 4px solid #4a90e2;
                border-radius: 50%;
                animation: spin 1s linear infinite;
                margin: 0 auto;
              "></div>
            </div>
            <div>データを取得中...</div>
            <div style="font-size: 12px; margin-top: 10px; opacity: 0.8;">
              全年次のデータを取得して、ピラミッドのサイズを計算しています
            </div>
          `;

          // CSS アニメーションを追加
          const style = document.createElement("style");
          style.textContent = `
            @keyframes spin {
              0% { transform: rotate(0deg); }
              100% { transform: rotate(360deg); }
            }
          `;
          document.head.appendChild(style);

          document.body.appendChild(loadingDiv);
        }

        // データ取得中の表示を非表示
        function hideDataLoadingMessage() {
          const loadingDiv = document.getElementById("data-loading-message");
          if (loadingDiv) {
            document.body.removeChild(loadingDiv);
          }
        }

        // アニメーション一時停止
        function pauseAnimationFromControls() {
          if (window.streamingAnimation) {
            window.streamingAnimation.pauseAnimation();
          }
        }

        // アニメーション再開
        function resumeAnimationFromControls() {
          if (window.streamingAnimation) {
            window.streamingAnimation.resumeAnimation();
          }
        }

        // アニメーション終了
        function stopAnimationFromControls() {
          // 元の選択状態を保存
          //const originalNengetsu = get_selected_nengetsu();
          //const originalPyramode = get_pyramid_mode();
          //console.log(
          //  `終了ボタン: 元の選択状態を保存 - 年次: ${originalNengetsu}, モード: ${originalPyramode}`
          //);

          // ストリーミングアニメーションの停止
          if (window.streamingAnimation) {
            window.streamingAnimation.stopAnimation();
          }

          // スライダーを無効化
          updateSliderState();

          // スライドバーの進捗度情報をクリア
          //const progressSlider = document.getElementById("animation-progress");
          //const progressDisplay = document.getElementById("progress-display");
          //if (progressSlider) {
          //  progressSlider.value = 0;
          //}
          //if (progressDisplay) {
          //  progressDisplay.textContent = "0%";
          //}

          //// 元の選択状態を復元
          //if (originalNengetsu && originalNengetsu !== undefined) {
          //  console.log(
          //    `終了ボタン: 元の選択状態を復元 - 年次: ${originalNengetsu}`
          //  );
          //  select_nengetsu(originalNengetsu, originalPyramode);
          //}
        }

        // スライダーの操作可否を制御する関数
        function updateSliderState() {
          const progressSlider = document.getElementById("animation-progress");
          if (!progressSlider) return;

          // アニメーションが初期化されているかチェック
          const isReady =
            window.streamingAnimation &&
            window.streamingAnimation.allYears &&
            window.streamingAnimation.allYears.length > 0 &&
            window.streamingAnimation.dataCache &&
            Object.keys(window.streamingAnimation.dataCache).length > 0;

          if (isReady) {
            progressSlider.style.pointerEvents = "auto"; // 操作可能
            console.log("スライダーを有効化しました（pointer-events: auto）");
          } else {
            progressSlider.style.pointerEvents = "none"; // 操作不可
            console.log("スライダーを無効化しました（pointer-events: none）");
          }
        }

        // アニメーション進行スライダーのイベントハンドラー
        function setupAnimationProgressSlider() {
          const progressSlider = document.getElementById("animation-progress");
          const progressDisplay = document.getElementById("progress-display");

          if (!progressSlider || !progressDisplay) return;

          let isDragging = false;

          // スライダーを100%の長さで表示（最大値を100に設定）
          progressSlider.max = 100;

          // 初期状態では無効化
          updateSliderState();

          // スライダーの値変更時
          progressSlider.addEventListener("input", function () {
            const progress = parseInt(this.value);
            progressDisplay.textContent = progress + "%";

            if (isDragging) {
              // ドラッグ中はツールチップのみ表示
              showSliderTooltip(progress);
            } else if (window.streamingAnimation) {
              // ドラッグ中でない場合はピラミッドを描画
              window.streamingAnimation.seekToProgress(progress);
            }
          });

          // ドラッグ開始
          progressSlider.addEventListener("mousedown", function () {
            isDragging = true;
            if (window.streamingAnimation) {
              window.streamingAnimation.pauseAnimation();
            }
          });

          // ドラッグ終了
          progressSlider.addEventListener("mouseup", function () {
            isDragging = false;
            hideSliderTooltip();

            if (window.streamingAnimation) {
              const progress = parseInt(this.value);
              // ドラッグ停止時にピラミッドを描画
              window.streamingAnimation.seekToProgress(progress);
              // 一時停止状態を維持（再開ボタンで手動再開）
            }
          });

          // タッチイベント対応
          progressSlider.addEventListener("touchstart", function () {
            isDragging = true;
            if (window.streamingAnimation) {
              window.streamingAnimation.pauseAnimation();
            }
          });

          progressSlider.addEventListener("touchend", function () {
            isDragging = false;
            hideSliderTooltip();

            if (window.streamingAnimation) {
              const progress = parseInt(this.value);
              // ドラッグ停止時にピラミッドを描画
              window.streamingAnimation.seekToProgress(progress);
              // 一時停止状態を維持（再開ボタンで手動再開）
            }
          });
        }

        // スライダーツールチップ表示
        function showSliderTooltip(progress) {
          const tooltip = document.getElementById("slider-tooltip");
          if (!tooltip || !window.streamingAnimation) return;

          // 進行度から年次を計算
          const targetIndex = Math.floor(
            (progress / 100) * (window.streamingAnimation.allYears.length - 1)
          );
          const clampedIndex = Math.max(
            0,
            Math.min(targetIndex, window.streamingAnimation.allYears.length - 1)
          );
          const targetYear = window.streamingAnimation.allYears[clampedIndex];

          // 年次をフォーマット
          const formattedYear =
            window.streamingAnimation.formatYear(targetYear);

          // ツールチップを表示
          tooltip.textContent = `基準日: ${formattedYear}`;
          tooltip.style.display = "block";
        }

        // スライダーツールチップ非表示
        function hideSliderTooltip() {
          const tooltip = document.getElementById("slider-tooltip");
          if (tooltip) {
            tooltip.style.display = "none";
          }
        }

        // 現在選択されている市区を日本語表記で取得
        function get_selected_shiku_japanese() {
          const index = document.getElementById("shiku").selectedIndex;
          const text = document.getElementById("shiku").options[index].text;
          return text;
        }

        // 市区・年次変更検知とキャッシュクリア
        function checkAndClearCacheIfShikuChanged() {
          if (!window.streamingAnimation) {
            console.log("StreamingAnimationManagerが存在しません");
            return;
          }

          // 現在選択されている市区を取得（日本語表記）
          const currentShiku = get_selected_shiku_japanese();
          console.log("現在選択されている市区:", currentShiku);

          // 現在選択されている年次を取得
          const currentNengetsu = get_selected_nengetsu();
          console.log("現在選択されている年次:", currentNengetsu);

          // キャッシュされている市区と年次を取得
          let cachedShiku = null;
          let cachedYear = null;
          if (
            window.streamingAnimation.dataCache &&
            Object.keys(window.streamingAnimation.dataCache).length > 0
          ) {
            const firstYear = Object.keys(
              window.streamingAnimation.dataCache
            )[0];
            cachedShiku = window.streamingAnimation.dataCache[firstYear]?.shiku;
            cachedYear = firstYear;
            console.log("キャッシュされている市区:", cachedShiku);
            console.log("キャッシュされている年次:", cachedYear);
          }

          // 年次の下2桁を取得する関数
          function getLastTwoDigits(nengetsu) {
            if (!nengetsu || typeof nengetsu !== "string") return "";
            return nengetsu.slice(-2);
          }

          // 判定条件
          let shouldClearCache = false;
          let reason = "";

          if (!cachedShiku) {
            // キャッシュが存在しない場合
            console.log(
              "キャッシュが存在しません（初回またはキャッシュクリア済み）"
            );
            return;
          }

          // 1. 市区が変更されている場合
          if (currentShiku !== cachedShiku) {
            shouldClearCache = true;
            reason = `市区が変更されました: ${cachedShiku} → ${currentShiku}`;
          }
          // 2. 年次の下2桁がどちらか一方だけが"09"の場合（市区ピラミッドと町丁別ピラミッドの切り替え）
          else {
            const currentLastTwo = getLastTwoDigits(currentNengetsu);
            const cachedLastTwo = getLastTwoDigits(cachedYear);

            const currentIsCho = currentLastTwo === "09";
            const cachedIsCho = cachedLastTwo === "09";

            if (currentIsCho !== cachedIsCho) {
              shouldClearCache = true;
              const currentType = currentIsCho ? "町丁別" : "市区";
              const cachedType = cachedIsCho ? "町丁別" : "市区";
              reason = `ピラミッドタイプが変更されました: ${cachedType} → ${currentType} (${cachedYear} → ${currentNengetsu})`;
            }
          }

          if (shouldClearCache) {
            console.log(reason);
            clearAnimationCache();
          } else {
            console.log("市区・年次ともに変更されていません");
          }
        }

        // アニメーションキャッシュをクリア
        function clearAnimationCache() {
          if (!window.streamingAnimation) return;

          console.log("アニメーションキャッシュをクリアします");

          // キャッシュデータをクリア
          window.streamingAnimation.dataCache = {};
          window.streamingAnimation.allYears = [];
          window.streamingAnimation.currentYearIndex = 0;
          window.streamingAnimation.maxTotalPopulation = null;
          window.streamingAnimation.baseZoomScale = null;

          // アニメーション状態は保持（市区変更時は新しいアニメーションを開始するため）
          // window.streamingAnimation.isAnimating = false; // 削除

          // タイマーをクリア
          if (window.streamingAnimation.animationInterval) {
            clearTimeout(window.streamingAnimation.animationInterval);
            window.streamingAnimation.animationInterval = null;
          }

          // スライドバーの状態をリセット
          const progressSlider = document.getElementById("animation-progress");
          const progressDisplay = document.getElementById("progress-display");
          if (progressSlider) {
            progressSlider.value = 0;
          }
          if (progressDisplay) {
            progressDisplay.textContent = "0%";
          }

          console.log("アニメーションキャッシュのクリアが完了しました");
        }

        // 動画ボタンのクリック処理
        function toggleAnimationPanel() {
          // 市区変更検知とキャッシュクリア
          checkAndClearCacheIfShikuChanged();

          showAnimationControls();
        }
        // ウィンドウリサイズ時に再度計算して反映
        window.addEventListener('resize', () => {
          console.log('画面サイズが変更されました！');
          adjust_title_size("h2-text");
        });

      </script>
    </body>
  </html>
</html>
