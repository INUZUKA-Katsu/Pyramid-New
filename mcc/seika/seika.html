<!doctype html>
<html lang="ja">
  <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="icon" type="image/png" sizes="16x16" href="/mcc/img/favicon.ico">
        <title>聖歌の歌詞検索</title>
        <style type="text/css">
          /* スマートフォンファースト*/
          /* 700px未満の画面で表示するときのスタイル */
          div.body {width: 80%;
                    margin-left: auto; margin-right: auto;
                   }
          h1       {font-size: 24px;}
          h4       {margin-bottom: 0.3em !important; font-size: 125%;text-align:center;}
          div.h4   {font-style:oblique;font-size:18px;}
          div.comment {margin:1em auto 1.5em auto !important;width:max-content; max-width:35em; font-size:small;}
          div.checkbox {margin:0 auto;width: max-content;}
          #lyric,#select_list {margin:1em auto;width: max-content;}
          #select_message {margin:1em;padding:0.5em;border:solid 1px red;width: max-content}
          #lyric   {font-size:110%;}
          #lyric_bottom {margin-bottom:4em;}
          td       {height:2em;}
          @media screen and (min-width: 599px){
            /* 830px以上の画面で表示するときのスタイル */
            h1       {font-size: 48px;}
            h4       {margin-bottom: 2em;}
            div.h4   {font-style:oblique;font-size: 32px;
                      margin:20px 0 0 0;
                     }
          }
          @media screen and (min-width: 960px){
            /* 1000px以上の画面で表示するときのスタイル */
            /*h1       {font-size: 100%;}*/
            h4       {margin-bottom: 0.5em;
                      font-size: 1.2em;}
            div.h4   {margin-bottom: 0;margin-top: 1em;}
          }
  		  </style>
        <script type="text/javascript">
          window.onload = function(){
            const inputs = document.querySelectorAll("input");
            inputs.forEach(input => {
                input.addEventListener("keydown", get_enter);
            });
          }
          function get_enter(e){
             if(e.code=='Enter'){
                let key=e.target.id;
                search(key);
             }
          }
          function is_priority(){
            let elm=document.getElementById('priority');
            if(elm.checked){
              return "priority";
            }else{
              return "non_priority";
            }
          }
          function search(key){
            clear_lyric();
            clear_select_list();
            clear_hr();
            let elm=document.getElementById(key);
            if(elm.value!=''){
              ajax(key,elm.value);
            }
          }
          function clear_search_word(key){
            let elm=document.getElementById(key);
            elm.value='';
          }
          function clear_lyric(){
            let elm=document.getElementById('lyric');
            elm.innerHTML=''
          }
          function clear_select_list(){
            let elm=document.getElementById('select_list');
            elm.innerHTML=''
          }
          function clear_hr(){
            const hr = document.getElementById("lyric_bottom");
            if (hr) { hr.remove(); }
          }
          function processing_of_response(response){
            let data=JSON.parse(response);
            let key=Object.keys(data)[0];
            let val=data[key];

            if(key=='lyric'){
              let elm=document.getElementById('lyric');
              elm.innerHTML=val.replace(/\n/g,"<br>")
              elm.scrollIntoView();

            }else if(key=='err_message'){
              alert(val);

            }else if(key=='title_list'){
              res=window.prompt(val+"\n番号を入力してください。",'')
              res=toHalfWidth(res);
              reg=new RegExp(res+' (.*)')
              ans=val.match(reg);
              ajax('TitleSearch',ans[1]);

            //}else if(key=='require_choice'){
            //  res=window.prompt("聖歌と新聖歌に該当のタイトルがありました。"+
            //  "\n聖歌=>1、新聖歌=>2 のいずれかの番号を入力してください。",'');
            //  res=toHalfWidth(res);
            //  ajax('cgi_key',val[res-1]);

            }else if(key=='lyric_search'){
              let title_ary=Object.keys(val)
              if(title_ary.length==1){
                title=title_ary[0].match(/『(.*)』/)[1]
                ajax('TitleSearch',title);
              }else{
                alert(title_ary.join("\n"));
              }

            }else if(key=='title_list_and_index'){
              res=window.prompt(val[0]+"\n番号を入力してください。",'')
              res=toHalfWidth(res);
              cgi_key=val[1][res-1];
              ajax('cgi_key',cgi_key);

            }else if(key=='matched_range_list'||key=='former_lyric_list'){
              let message="<div id='select_message'>該当する聖歌が、"+val[1]+"件ありました。<br>"+
                             "タイトルの横の選択ボタンを押すと、<br>"+
                             "その聖歌の歌詞全体を表示します。</div>";
              let elm1=document.getElementById('select_list');
              elm1.innerHTML = message + val[0].replace(/\n/g,"<br>")
            }        
          }
          function disp_lyric(elm){
            cgi_key=elm.name
            ajax('cgi_key', cgi_key);
            add_hr();
            document.getElementById("separater").scrollIntoView();
          }
          function add_hr(){
            if(!document.getElementById('lyric_bottom')){;
              // #lyric の後に <hr> を追加する。
              let hr = document.createElement("hr");
              hr.id  = "lyric_bottom"
              hr.style.width = "80%"; // 幅を設定
              let lyric_div = document.getElementById("lyric");
              lyric_div.insertAdjacentElement("afterend", hr);
            }
          }
          function ajax(mode,key,i){
            if(i===undefined){i=1;}
            var xmlHttp  = null;
            xmlHttp = new XMLHttpRequest();
            if(null == xmlHttp ) { // 初期化失敗時
              return ;
            }
            //タイムアウトの設定（5回試行する.）
            var timerId=window.setTimeout(function(){
                xmlHttp.abort();
                time_stamp();
                if(i<5){
                  i++;
                  ajax(mode,key,i);
                }else{
                  set_comment("on","データを読み込めませんでした。",1000);
                }
              },5000);
            //応答時の処理定義
            xmlHttp.onreadystatechange = function(){
               if(xmlHttp.readyState == 4 && xmlHttp.status == 200){
                  window.clearTimeout(timerId);
                  set_comment("off");
                  var response=xmlHttp.responseText;
                  processing_of_response(response);
               }
            }
            let SendData=mode+"="+key+"&priority="+is_priority()
            xmlHttp.open("POST" , "./seika.cgi" , true);
            xmlHttp.setRequestHeader("content-type",
                "application/x-www-form-urlencoded");
            encodeURIComponent(SendData).replace(/%20/g,'+');
            xmlHttp.send(SendData);
          }
          function time_stamp(){
            var now  = new Date();
            var hh = now.getHours();
            var mm  = now.getMinutes();
            var ss  = now.getSeconds();
            console.log(hh+':'+mm+':'+ss)
          }
          function set_comment(display, mes , timer){
            if(display=="on"){
              document.getElementById("comment").style.display="block";
              document.getElementById("comment").innerHTML=mes;
              if(timer!==undefined){
                window.setTimeout(function(){
                  set_comment("off");
                },timer);
              }
            }else if(display=="off"){
              document.getElementById("comment").style.display="none";
            }
          }
          function toHalfWidth(str){
            // 全角英数字を半角に変換
            str = str.replace(/[Ａ-Ｚａ-ｚ０-９]/g, function(s) {
              return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
            });
            return str;
          }
        </script>
  </head>
  <body>
    <h4>聖歌の歌詞検索</h4>
    <div class="comment">※このサイトは<a href="http://lifebread.info/cgi-bin/hymn_list4.cgi/">http://lifebread.info/cgi-bin/hymn_list4.cgi/</a>に掲載されている歌詞、タイトル等の情報を使わせていただき、聖歌をさまざまに検索できるようにしたものです。</div>
    <div class="checkbox"><input type="checkbox" id="priority" checked>聖歌(総合版)を優先する.</div>
    <table style="margin:1em auto auto auto;">
        <tr>
            <td border="none" colspan=2>聖歌番号から検索する</td>
        </tr>
        <tr>
            <td>　<input type="text" id="NumSearch"></td>
            <td>
                <button onClick="search('NumSearch');">検索実行</button>
                <button onClick="clear_search_word('NumSearch');">クリア</button>
            </td>
        </tr>
        <tr>
            <td border="none" colspan=2>聖歌のタイトル又はタイトルの一部から検索する</td>
        </tr>
        <tr>
            <td>　<input type="text" id="TitleSearch"></td>
            <td>
                <button onClick="search('TitleSearch');">検索実行</button>
                <button onClick="clear_search_word('TitleSearch');">クリア</button>
            </td>
        </tr>
        <tr>
            <td border="none" colspan=2>歌詞に含まれる語句から検索する</td>
        </tr>
        <tr>
            <td>　<input type="text" id="LyricSearch"></td>
            <td>
                <button onClick="search('LyricSearch');">検索実行</button>
                <button onClick="clear_search_word('LyricSearch');">クリア</button>
            </td>
        </tr>
        <tr>
            <td colspan="2" id="comment"></td>
        </tr>
    </table>
    <hr width="80%" id="separater">
    <div id="lyric"></div>
    
    <div id="select_list"></div>
  </body>
</html>
